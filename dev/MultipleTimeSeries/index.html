<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Fitting a model to multiple time series · UniversalDiffEq.jl</title><meta name="title" content="Fitting a model to multiple time series · UniversalDiffEq.jl"/><meta property="og:title" content="Fitting a model to multiple time series · UniversalDiffEq.jl"/><meta property="twitter:title" content="Fitting a model to multiple time series · UniversalDiffEq.jl"/><meta name="description" content="Documentation for UniversalDiffEq.jl."/><meta property="og:description" content="Documentation for UniversalDiffEq.jl."/><meta property="twitter:description" content="Documentation for UniversalDiffEq.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">UniversalDiffEq.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">UniversalDiffEq.jl</a></li><li><a class="tocitem" href="../Models/">Model Constructors</a></li><li><a class="tocitem" href="../EasyModels/">Easy NODE and UDE</a></li><li><a class="tocitem" href="../ModelTesting/">Model performance</a></li><li><a class="tocitem" href="../NutsAndBolts/">UDE model construction</a></li><li class="is-active"><a class="tocitem" href>Fitting a model to multiple time series</a><ul class="internal"><li><a class="tocitem" href="#Multiple-time-series-custom-models"><span>Multiple time series custom models</span></a></li></ul></li><li><a class="tocitem" href="../modelanalysis/">Model analysis</a></li><li><a class="tocitem" href="../BayesianModels/">Bayesian Models</a></li><li><a class="tocitem" href="../examples/">Examples</a></li><li><a class="tocitem" href="../API/">API</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Fitting a model to multiple time series</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Fitting a model to multiple time series</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/Jack-H-Buckner/UniversalDiffEq.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/Jack-H-Buckner/UniversalDiffEq.jl/blob/main/docs/src/MultipleTimeSeries.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Fitting-a-model-to-multiple-time-series"><a class="docs-heading-anchor" href="#Fitting-a-model-to-multiple-time-series">Fitting a model to multiple time series</a><a id="Fitting-a-model-to-multiple-time-series-1"></a><a class="docs-heading-anchor-permalink" href="#Fitting-a-model-to-multiple-time-series" title="Permalink"></a></h1><p>UniversalDiffEq.jl provides a set of functions to fit models to multiple time series. The functions for this mirror the functions for fitting NODEs and UDEs to single time series with the prefix <code>Multi</code>. For example, to build a NODE model for multiple time series you would use the <code>MultiNODE</code> function. The functions for model fitting, testing, and visualization have the same names. The other important difference is the data format: a column with a unique index for each time series must be included.</p><p><strong>Table</strong>: Example data frame with multiple time series</p><table><tr><th style="text-align: right"><code>time</code></th><th style="text-align: right"><code>series</code></th><th style="text-align: right"><span>$x_1$</span></th><th style="text-align: right"><span>$x_2$</span></th></tr><tr><td style="text-align: right">1</td><td style="text-align: right">1</td><td style="text-align: right"><span>$x_{1,1,t}$</span></td><td style="text-align: right"><span>$x_{1,2,t}$</span></td></tr><tr><td style="text-align: right">2</td><td style="text-align: right">1</td><td style="text-align: right"><span>$x_{1,1,t}$</span></td><td style="text-align: right"><span>$x_{1,2,t}$</span></td></tr><tr><td style="text-align: right">3</td><td style="text-align: right">1</td><td style="text-align: right"><span>$x_{1,1,t}$</span></td><td style="text-align: right"><span>$x_{1,2,t}$</span></td></tr><tr><td style="text-align: right">1</td><td style="text-align: right">2</td><td style="text-align: right"><span>$x_{2,1,t}$</span></td><td style="text-align: right"><span>$x_{2,2,t}$</span></td></tr><tr><td style="text-align: right">2</td><td style="text-align: right">2</td><td style="text-align: right"><span>$x_{2,1,t}$</span></td><td style="text-align: right"><span>$x_{2,2,t}$</span></td></tr><tr><td style="text-align: right">3</td><td style="text-align: right">2</td><td style="text-align: right"><span>$x_{2,1,t}$</span></td><td style="text-align: right"><span>$x_{2,2,t}$</span></td></tr></table><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="UniversalDiffEq.MultiNODE-Tuple{Any}-MultipleTimeSeries" href="#UniversalDiffEq.MultiNODE-Tuple{Any}-MultipleTimeSeries"><code>UniversalDiffEq.MultiNODE</code></a> — <span class="docstring-category">Method</span></header><section><div><pre><code class="language-julia hljs">MultiNODE(data;kwargs...)</code></pre><p>builds a NODE model to fit to the data. <code>data</code> is a DataFrame object with time arguments placed in a column labed <code>t</code> and a second column with a unique index for each time series. The remaining columns have observations of the state variables at each point in time and for each time series.</p><p><strong>kwargs</strong></p><ul><li><code>time_column_name</code>: Name of column in <code>data</code> that corresponds to time. Default is <code>&quot;time&quot;</code>.</li><li><code>series_column_name</code>: Name of column in <code>data</code> that corresponds to time. Default is <code>&quot;series&quot;</code>.</li><li><code>hidden_units</code>: Number of neurons in hidden layer. Default is <code>10</code>.</li><li><code>seed</code>: Fixed random seed for repeatable results. Default is <code>1</code>.</li><li><code>proc_weight</code>: Weight of process error <code>omega_{proc}</code>. Default is <code>1.0</code>.</li><li><code>obs_weight</code>: Weight of observation error <code>omega_{obs}</code>. Default is <code>1.0</code>.</li><li><code>reg_weight</code>: Weight of regularization error <code>omega_{reg}</code>. Default is <code>10^-6</code>.</li><li><code>reg_type</code>: Type of regularization, whether <code>&quot;L1&quot;</code> or <code>&quot;L2&quot;</code> regularization. Default is <code>&quot;L2&quot;</code>.</li><li><code>l</code>: Extrapolation parameter for forecasting. Default is <code>0.25</code>.</li><li><code>extrap_rho</code>: Extrapolation parameter for forecasting. Default is <code>0.0</code>.</li></ul></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Jack-H-Buckner/UniversalDiffEq.jl/blob/fd9bceb2a8fe265aad1b82775f4997b72767cb32/src/MultipleTimeSeries.jl#L160-L178">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="UniversalDiffEq.MultiNODE-Tuple{Any, Any}-MultipleTimeSeries" href="#UniversalDiffEq.MultiNODE-Tuple{Any, Any}-MultipleTimeSeries"><code>UniversalDiffEq.MultiNODE</code></a> — <span class="docstring-category">Method</span></header><section><div><pre><code class="language-julia hljs">MultiNODE(data,X;kwargs...)</code></pre><p>When a dataframe <code>X</code> is supplied the model will run with covariates. the argument <code>X</code> should have a column for time <code>t</code> with the value for time in the remaining columns. The values in <code>X</code> will be interpolated with a linear spline for values of time not included in the data frame. </p><p><strong>kwargs</strong></p><ul><li><code>time_column_name</code>: Name of column in <code>data</code> that corresponds to time. Default is <code>&quot;time&quot;</code>.</li><li><code>series_column_name</code>: Name of column in <code>data</code> that corresponds to time. Default is <code>&quot;series&quot;</code>.</li><li><code>variable_column_name</code>: Name of column in <code>data</code> that corresponds to the covariates. Default is <code>&quot;variable&quot;</code>. </li><li><code>value_column_name</code>: Name of column in <code>data</code> that corresponds to the covariates. Default is <code>&quot;value&quot;</code>. </li><li><code>hidden_units</code>: Number of neurons in hidden layer. Default is <code>10</code>.</li><li><code>seed</code>: Fixed random seed for repeatable results. Default is <code>1</code>.</li><li><code>proc_weight</code>: Weight of process error <code>omega_{proc}</code>. Default is <code>1.0</code>.</li><li><code>obs_weight</code>: Weight of observation error <code>omega_{obs}</code>. Default is <code>1.0</code>.</li><li><code>reg_weight</code>: Weight of regularization error <code>omega_{reg}</code>. Default is <code>10^-6</code>.</li><li><code>reg_type</code>: Type of regularization, whether <code>&quot;L1&quot;</code> or <code>&quot;L2&quot;</code> regularization. Default is <code>&quot;L2&quot;</code>.</li><li><code>l</code>: Extrapolation parameter for forecasting. Default is <code>0.25</code>.</li><li><code>extrap_rho</code>: Extrapolation parameter for forecasting. Default is <code>0.0</code>.</li></ul></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Jack-H-Buckner/UniversalDiffEq.jl/blob/fd9bceb2a8fe265aad1b82775f4997b72767cb32/src/MultipleTimeSeries.jl#L217-L236">source</a></section></article><h2 id="Multiple-time-series-custom-models"><a class="docs-heading-anchor" href="#Multiple-time-series-custom-models">Multiple time series custom models</a><a id="Multiple-time-series-custom-models-1"></a><a class="docs-heading-anchor-permalink" href="#Multiple-time-series-custom-models" title="Permalink"></a></h2><p>Custom models can be trained on multiple time series using the <code>MultiCustomDerivatives</code> function. The user-defined function that builds these models requires an additional argument, <code>i</code> added as the third argument  (e.g., <code>derivs!(du,u,i,X,p,t)</code>, <code>derivs!(du,u,i,p,t)</code>). The UniversalDiffEq.jl library will use this argument to pass a unique index for each time series. These indices can then be used to estimate different parameter values for each time series as illustrated in the following examples.</p><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="UniversalDiffEq.MultiCustomDerivatives-Tuple{Any, Any, Any}-MultipleTimeSeries" href="#UniversalDiffEq.MultiCustomDerivatives-Tuple{Any, Any, Any}-MultipleTimeSeries"><code>UniversalDiffEq.MultiCustomDerivatives</code></a> — <span class="docstring-category">Method</span></header><section><div><pre><code class="language-julia hljs">MultiCustomDerivatives(data,derivs!,initial_parameters;kwargs...)</code></pre><p>Builds a UDE model that can be trianed on multiple time series simultaniously. The user defined derivatives functions must allow for an extra argument <code>i</code> that indexes over the time seris in the data set (e.g. <code>derivs!(du,u,i,)</code>). <code>data</code> is a DataFrame object with time arguments placed in a column labeled <code>t</code> and a second column with a unique index for each time series. The remaining columns have observations of the state variables at each point in time and for each time series.</p><p><strong>kwargs</strong></p><ul><li><code>time_column_name</code>: Name of column in <code>data</code> that corresponds to time. Default is <code>&quot;time&quot;</code>.</li><li><code>series_column_name</code>: Name of column in <code>data</code> that corresponds to time. Default is <code>&quot;series&quot;</code>.</li><li><code>variable_column_name</code>: Name of column in <code>data</code> that corresponds to the variables. Default is <code>&quot;variable&quot;</code>.</li><li><code>value_column_name</code>: Name of column in <code>data</code> that corresponds to the covariates. Default is <code>&quot;value&quot;</code>.</li><li><code>proc_weight</code>: Weight of process error <code>omega_{proc}</code>. Default is <code>1.0</code>.</li><li><code>obs_weight</code>: Weight of observation error <code>omega_{obs}</code>. Default is <code>1.0</code>.</li><li><code>reg_weight</code>: Weight of regularization error <code>omega_{reg}</code>. Default is <code>10^-6</code>.</li><li><code>reg_type</code>: Type of regularization, whether <code>&quot;L1&quot;</code> or <code>&quot;L2&quot;</code> regularization. Default is <code>&quot;L2&quot;</code>.</li><li><code>l</code>: Extrapolation parameter for forecasting. Default is <code>0.25</code>.</li><li><code>extrap_rho</code>: Extrapolation parameter for forecasting. Default is <code>0.0</code>.</li></ul></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Jack-H-Buckner/UniversalDiffEq.jl/blob/fd9bceb2a8fe265aad1b82775f4997b72767cb32/src/MultipleTimeSeries.jl#L277-L294">source</a></section></article><h3 id="Example-1:-Estimating-unique-growth-rates-for-population-time-series"><a class="docs-heading-anchor" href="#Example-1:-Estimating-unique-growth-rates-for-population-time-series">Example 1: Estimating unique growth rates for population time series</a><a id="Example-1:-Estimating-unique-growth-rates-for-population-time-series-1"></a><a class="docs-heading-anchor-permalink" href="#Example-1:-Estimating-unique-growth-rates-for-population-time-series" title="Permalink"></a></h3><p>To illustrate how unique parameters can be estimated for separate time series, we build a generalized logistic model that uses a neural network to describe the density dependence of the populations and estimates unique growth rates for each time series</p><p class="math-container">\[\frac{du_i}{dt} = r_i u_i NN(u_i).\]</p><p>To build this model, we use the argument <code>i</code> of the <code>derivs!</code> function to index it into a vector of growth rate parameters. Notice that we need to transform <code>i</code> to be an integer for the indexing operation by calling <code>round(Int,i)</code> and we initialize the growth rate parameter <code>r</code>.</p><pre><code class="language-julia hljs"># set up neural network
using Lux
dims_in = 1
hidden_units = 10
nonlinearity = tanh
dims_out = 1
NN = Lux.Chain(Lux.Dense(dims_in,hidden_units,nonlinearity),Lux.Dense(hidden_units,dims_out))

# initialize parameters
using Random
rng = Random.default_rng()
NNparameters, NNstates = Lux.setup(rng,NN)

function derivs!(du,u,i,p,t)
    index = round(Int,i)
    du .= p.r[index].* u .* NN(u,p.NN, NNstates)[1]

end

m = 2 # number of time series
init_parameters = (NN = NNparameters, r = zeros(m), )

model = MultiCustomDerivatives(training_data,derivs!,init_parameters;proc_weight=2.0,obs_weight=0.5,reg_weight=10^-4)</code></pre><h3 id="Example-2:-Allowing-a-neural-network-to-vary-between-time-series"><a class="docs-heading-anchor" href="#Example-2:-Allowing-a-neural-network-to-vary-between-time-series">Example 2: Allowing a neural network to vary between time series</a><a id="Example-2:-Allowing-a-neural-network-to-vary-between-time-series-1"></a><a class="docs-heading-anchor-permalink" href="#Example-2:-Allowing-a-neural-network-to-vary-between-time-series" title="Permalink"></a></h3><p>In some cases, we may want to allow the neural networks to vary between time series so that they can estimate unknown functions specific to each time series. This can be achieved by passing an indicator variable to the neural network that encodes the time series being fit using <a href="https://www.geeksforgeeks.org/ml-one-hot-encoding/">one-hot encoding</a>. This method allows the model to learn unique functions for each time series if appropriate, while also sharing information about the unknown function between time series.</p><p>To illustrate this, define a NODE model that takes the indicator variable as an additional argument.</p><pre><code class="language-julia hljs"># set up neural network
m = 10 # number of time series
using Lux
dims_in = 2+m #two inputs for the state variable plus m inputs for the one-hot encoding
hidden_units = 10
nonlinearity = tanh
dims_out = 2
NN = Lux.Chain(Lux.Dense(dims_in,hidden_units,nonlinearity),Lux.Dense(hidden_units,dims_out))

# initialize parameters
using Random
rng = Random.default_rng()
NNparameters, NNstates = Lux.setup(rng,NN)

function derivs!(du,u,i,X,p,t)
    index = round(Int,i)
    one_hot = zeros(m)
    one_hot[index] = 1
    du .=  NN(vcat(u,one_hot) ,p.NN, NNstates)[1]
end

init_parameters = (NN = NNparameters, )

model = MultiCustomDerivatives(training_data,derivs!,init_parameters;proc_weight=2.0,obs_weight=0.5,reg_weight=10^-4)
nothing</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../NutsAndBolts/">« UDE model construction</a><a class="docs-footer-nextpage" href="../modelanalysis/">Model analysis »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.3.0 on <span class="colophon-date" title="Wednesday 18 December 2024 21:22">Wednesday 18 December 2024</span>. Using Julia version 1.7.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
