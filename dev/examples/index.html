<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Examples · UniversalDiffEq.jl</title><meta name="title" content="Examples · UniversalDiffEq.jl"/><meta property="og:title" content="Examples · UniversalDiffEq.jl"/><meta property="twitter:title" content="Examples · UniversalDiffEq.jl"/><meta name="description" content="Documentation for UniversalDiffEq.jl."/><meta property="og:description" content="Documentation for UniversalDiffEq.jl."/><meta property="twitter:description" content="Documentation for UniversalDiffEq.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">UniversalDiffEq.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">UniversalDiffEq.jl</a></li><li><a class="tocitem" href="../Models/">Model Constructors</a></li><li><a class="tocitem" href="../TrainingRoutines/">Training routines</a></li><li><a class="tocitem" href="../ModelTesting/">Model performance</a></li><li><a class="tocitem" href="../CrossValidation/">Cross validation</a></li><li><a class="tocitem" href="../NutsAndBolts/">UDE model construction</a></li><li><a class="tocitem" href="../MultipleTimeSeries/">Fitting a model to multiple time series</a></li><li><a class="tocitem" href="../modelanalysis/">Model analysis</a></li><li class="is-active"><a class="tocitem" href>Examples</a><ul class="internal"><li><a class="tocitem" href="#Using-time-dependent-NODEs-to-predict-regime-shifts"><span>Using time-dependent NODEs to predict regime shifts</span></a></li><li><a class="tocitem" href="#Using-UDEs-to-learn-the-dynamics-of-coupled-human-natural-systems"><span>Using UDEs to learn the dynamics of coupled human-natural systems</span></a></li></ul></li><li><a class="tocitem" href="../API/">API</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Examples</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Examples</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/Jack-H-Buckner/UniversalDiffEq.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/Jack-H-Buckner/UniversalDiffEq.jl/blob/main/docs/src/examples.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Examples"><a class="docs-heading-anchor" href="#Examples">Examples</a><a id="Examples-1"></a><a class="docs-heading-anchor-permalink" href="#Examples" title="Permalink"></a></h1><h2 id="Using-time-dependent-NODEs-to-predict-regime-shifts"><a class="docs-heading-anchor" href="#Using-time-dependent-NODEs-to-predict-regime-shifts">Using time-dependent NODEs to predict regime shifts</a><a id="Using-time-dependent-NODEs-to-predict-regime-shifts-1"></a><a class="docs-heading-anchor-permalink" href="#Using-time-dependent-NODEs-to-predict-regime-shifts" title="Permalink"></a></h2><p>One interesting use of NODE and UDE models in ecology is detecting and predicting regime shifts, which are sudden changes in the structure and function of an ecosystem often associated with a change in conditions. Regime shifts are caused by the interaction of nonlinear feedback mechanisms, environmental variability, and long-term environmental change. NODE and UDE models built with UniversalDiffEq.jl can capture all three of these processes, making it possible to detect and predict regime shifts from data.</p><p>In the following example, we build a NODE model for a two-species system that undergoes a regime shift. The data are simulated from the Mumby et al. (2007) model of coral-algae competition with an added term for stochastic coral mortality events and a long-term increase in the coral mortality rate from increasing temperature. The increasing temperature eventually causes the system to shift from a coral-dominated to an algae-dominated state (Fig. 1). The data from the time of the regime shift are used to fit the model.</p><p><img src="../figures/regiem_changes_data.png" alt="Figure 1: simulated regime shift data "/></p><p><strong>Figure 1</strong>: Time series of simulated coral and algae abundances. The vertical dashed line indicates an increase in temperature associated with coral mortality.</p><p>The model is a function of the area covered by coral <span>$p_C$</span> and algae <span>$p_A$</span>, an environmental covariate <span>$X$</span> that is related to coral mortality, and time <span>$t$</span> to capture the effect of the slowly increasing coral mortality rate. The coral and macroalgae abundances are transformed to <span>$x_i = softmax^{-1}(p_i)$</span> using the inverse softmax transformation before fitting the model</p><p class="math-container">\[   \frac{dx_C}{dt} = NN_1(x_C,x_A,X,t) \\
   \frac{dx_A}{dt} = NN_2(x_C,x_A,X,t) \\\]</p><p>UniversalDiffEq.jl does not have built-in methods to construct time-dependent NODEs, but they can be built easily using the <code>CustomDerivatives</code> function. In this case, we initialize a neural network that takes four inputs (one each for coral cover, algae cover, the environmental covariate, and time) and two outputs using Lux.jl. The derivatives function <code>derivs!</code> divides time by 50 to match the scale of the other inputs; then concatenates the abundances of each species, the covariate <span>$X$</span>, and time into a vector; and finally evaluates the neural network. The UDE model is constructed using the <code>CustomDerivatives</code> function, passing both the species data in a data frame called <code>data</code> and the covariate in a data frame called <code>X</code>.</p><pre><code class="language-julia hljs">using Lux, UniversalDiffEq
# generate synthetic data
data,X = simulate_coral_data()


# set neural network dimensions
dims_in = 4
dims_out = 2
hidden = 10


# Define neural network with Lux.jl
NN = Lux.Chain(Lux.Dense(dims_in, hidden, tanh), Lux.Dense(hidden, dims_out))
rng = Random.default_rng()
NNparameters, NNstates = Lux.setup(rng,NN)
parameters = (NN = NNparameters,)


# Define derivatives (time dependent NODE)
function derivs!(du,u,X,p,t)
    vals = NN([u[1],u[2],X[1],t/50-1.0],p.NN,NNstates)[1]
    du[1] = vals[1]
    du[2] = vals[2]
    return du
end

model = UniversalDiffEq.CustomDerivatives(data[1:80,:],X,derivs!,parameters;proc_weight=2.5,obs_weight=10.0,reg_weight=10^-2.5)

gradient_descent!(model, verbose = true, maxiter = 500)
gradient_descent!(model, verbose = true, maxiter = 500, step_size = 0.01)
nothing</code></pre><p>We can use the <code>plot_state_estimates</code> and <code>plot_predictions</code> functions to test the fit of the model to the training data.</p><pre><code class="language-julia hljs">UniversalDiffEq.plot_state_estimates(model)</code></pre><p><img src="../figures/regiem_changes_state_estiamtes.png" alt/></p><pre><code class="language-julia hljs">UniversalDiffEq.plot_predictions(model)</code></pre><p><img src="../figures/regiem_changes_predictions.png" alt/></p><p>Unsurprisingly, given that this is simulated data, our model was able to fit the training data very closely.</p><p>Given that the model fits the data well, we can move on to our analysis. The goal of this model is to capture the effects of a slowly changing variable on the dynamics of the coral-algae system. In particular, we want to identify any potential regime shifts, points in time where a small change in the environment leads to a large change in the state of the ecosystem. Often, regime shifts are characterized by the appearance or disappearance of equilibrium points in a dynamical system. We can identify these events by tracking changes in the derivatives function of the NODE model over time. This function is the right-hand side of a system of ODEs and, therefore, can be analyzed for equilibrium points and their stability. Because the NODE model is time-dependent, new equilibria may appear or existing ones may change their stability creating a regime shift.</p><p>To identify regime shifts, we can extract the right-hand side of the ODE from the fitted model using the <code>get_right_hand_side</code> function. In the following example, we use the derivatives function <code>RHS</code> to plot a vector field for the coral and macroalgae at four points in time.</p><pre><code class="language-julia hljs">using Plots
p1 = vectorfield_and_nullclines(model,[0.0];t = 0, n = 15, lower = [-2.0,-2.0], upper = [2.0,2.0])
p2 = vectorfield_and_nullclines(model,[0.0];t = 70, n = 15, lower = [-2.0,-2.0], upper = [2.0,2.0])
p3 = vectorfield_and_nullclines(model,[0.0];t = 100, n = 15, lower = [-2.0,-2.0], upper = [2.0,2.0])
p4 = vectorfield_and_nullclines(model,[0.0];t = 130, n = 15, lower = [-2.0,-2.0], upper = [2.0,2.0])
plt = plot(p1,p2,p3,p4)
savefig(plt,&quot;../docs/src/figures/regiem_changes_vector plots.png&quot;)
plt</code></pre><p><img src="../figures/regiem_changes_vector plots.png" alt/></p><p>The vector plots show clear changes in the dynamics of the system over time that likely constitute a regime shift from a coral-dominated state an algae-dominated state. For small values of time, the vector fields all point to the upper left, which is high coral abundance and low algae abundance. Over time, however, a second equilibrium appears in the lower right: low coral and high algae abundance. The final vector field, t = 130, predicts 50 years into the future after the end of the time series. This plot predicts that the basin of attraction around the algae-dominated state will continue to grow, which is consistent with the data, and shows a sudden switch from high coral to high algae abundance.</p><p>We can also illustrate the regime shift in the system by plotting the equilibrium coral and algae abundances for different values of time using the <code>equilibrium_and_stability</code> function. The following code block uses <code>equilibrium_and_stability</code> to calculate the equilibrium point of the model at each point in time and colors stable equilibrium points black and unstable equilibrium points white. This analysis shows the coral-dominated equilibrium bifurcating into two equilibrium points after time 120. Some additional equilibrium points are also identified over time.</p><pre><code class="language-julia hljs">p1 = Plots.plot(ylims = (-2.5,2.0), ylabel = &quot;Coral&quot;)
p2 = Plots.plot(ylims = (-2.5,2.0), xlabel = &quot;Time&quot;, ylabel = &quot;Algae&quot;)
for t in 1:2:180
    print(t,&quot; &quot;)
    eqs,evals = equilibrium_and_stability(model,[0.0],[-2.0,-2.0],[2.0,2.0];t=t,Ntrials=50)

    for i in eachindex(eqs)
        col = &quot;white&quot;
        if evals[i] &lt; 0 #negative real part of the dominant eigenvalue indicates long-term stability
            col = &quot;black&quot;
        end
        Plots.scatter!(p1,[t],eqs[i][2:2],color=col, label = &quot;&quot;)
        Plots.scatter!(p2,[t],eqs[i][1:1],color=col, label = &quot;&quot;)
    end
end
plt=Plots.plot(p1,p2,layout = (2,1))
savefig(plt,&quot;../docs/src/figures/regiem_changes_bifrucation_plot.png&quot;)
plt</code></pre><p><img src="../figures/regiem_changes_bifrucation_plot.png" alt/></p><h3 id="References"><a class="docs-heading-anchor" href="#References">References</a><a id="References-1"></a><a class="docs-heading-anchor-permalink" href="#References" title="Permalink"></a></h3><p>Mumby, P. J., Hastings, A. &amp; Edwards, H. J. Thresholds and the resilience of Caribbean coral reefs. Nature 450, 98–101 (2007).</p><h2 id="Using-UDEs-to-learn-the-dynamics-of-coupled-human-natural-systems"><a class="docs-heading-anchor" href="#Using-UDEs-to-learn-the-dynamics-of-coupled-human-natural-systems">Using UDEs to learn the dynamics of coupled human-natural systems</a><a id="Using-UDEs-to-learn-the-dynamics-of-coupled-human-natural-systems-1"></a><a class="docs-heading-anchor-permalink" href="#Using-UDEs-to-learn-the-dynamics-of-coupled-human-natural-systems" title="Permalink"></a></h2><p>Natural resources like fisheries are examples of coupled human and natural systems, where human activities influence the state of the natural system, and the environment influences human activities. One of the primary goals of coupled human-natural systems research is understanding how these cycles of mutual causation determine biological and social outcomes. We may also wish to understand how interventions from regulators modify interactions between people and their environment to identify if these interventions achieve their desired effects.</p><p>In this example, we build a UDE model to describe how the interactions between a fishing fleet and the exploited population change before and after the government limits entry into the fishery and predict the counterfactual outcomes in the absence of regulation.</p><h3 id="Data:-US-West-Coast-Cowcod-Fishery"><a class="docs-heading-anchor" href="#Data:-US-West-Coast-Cowcod-Fishery">Data: US West Coast Cowcod Fishery</a><a id="Data:-US-West-Coast-Cowcod-Fishery-1"></a><a class="docs-heading-anchor-permalink" href="#Data:-US-West-Coast-Cowcod-Fishery" title="Permalink"></a></h3><p>For this example, we use data from groundfish fisheries on the West Coast of the United States. These fisheries were managed under an open-access framework until 1992 when entry into the fishery was restricted following large declines in catch and abundance. We gathered data on the stock biomass <span>$B$</span> (proxy for abundance) and harvest <span>$H$</span> from the RAM legacy database and coded the change in regulations using binary variable <span>$I_{LE}$</span> that switched from zero to one in 1992 when limited entry regulations began. The time series of these three variables are shown below.</p><pre><code class="language-julia hljs">using CSV, Plots, DataFrames
data = CSV.read(&quot;CowCodFishery.csv&quot;,DataFrame)
plt = Plots.scatter(data.t,data.y, label = &quot;log Abundance&quot;, xlabel = &quot;Time&quot;, ylabel = &quot;value&quot;, width = 2)
Plots.scatter!(data.t,data.H, label = &quot;Harvest&quot;, width = 2)
Plots.scatter!(data.t,data.limited_entry, label = &quot;Limited entry&quot;, width = 2)</code></pre><p><img src="../figures/bioeconomic_data.png" alt/></p><h3 id="Model"><a class="docs-heading-anchor" href="#Model">Model</a><a id="Model-1"></a><a class="docs-heading-anchor-permalink" href="#Model" title="Permalink"></a></h3><p>We use a logistic growth model to describe the changes in the population biomass and model changes in harvest as a function of the stock, the current harvest, and regulations. The factors that drive changes in harvest may be complex and nonlinear so we use a neural network to model the rate of change of harvest. Combining these assumptions yields a system of differential equations that we fit to the data using the UniversalDiffEq.jl package</p><p class="math-container">\[\frac{dH}{dt} = NN(H,B,I_{LE};w,b)\\
\\
\frac{dB}{dt} = rB(1-B/K) - qH,\]</p><p>where <span>$r$</span> is the growth rate of the population, <span>$K$</span> is the carrying capacity, <span>$q$</span> is a scaling factor to match the units of stock biomass and harvest, <span>$w$</span> is the set of neural network weights, and <span>$b$</span> is the set of neural network biases. We define the model using a neural network from Lux.jl and the <code>CustomDerivatives</code> function. We fit the model parameters using the gradient descent and BFGS algorithms.</p><pre><code class="language-julia hljs"># set up neural network
using UniversalDiffEq, Lux, Random
dims_in = 3
hidden = 10
NN = Lux.Chain(Lux.Dense(dims_in,hidden,tanh),Lux.Dense(hidden,1))
rng = Random.default_rng()
NNparameters, NNstates = Lux.setup(rng,NN)

# set initial parameters
init_parameters = (NN = NNparameters, q = 1.0, r = 0.5, K = 4.0)

# Define model
function derivs!(du,u,X,p,t)
    du[1] = NN(vcat(u,X),p.NN,NNstates)[1][1] # harvest
    du[2] = p.r*u[2]*(1-u[2]/p.K) - p.q*u[1] # logistic growth minus harvest x scaling coef
end

# organize data
state_variables = DataFrame(t = data.t, H = data.H, y = exp.(data.y))
covariates = DataFrame(t = data.t, X = data.limited_entry)

# initialize model
model = CustomDerivatives(state_variables,covariates,derivs!,init_parameters;proc_weight=2.0,obs_weight=0.5,reg_weight=10^-4.0)

# fit the model
gradient_descent!(model,verbose = true)
BFGS!(model,verbos = true)
nothing</code></pre><p>We can evaluate the model fit using <code>plot_state_estimates</code> and <code>plot_predictions</code> functions to compare the estimated state variables to the data and the predicted changes in state variables to the observed changes between time steps. The fitted model performs well by visual inspection on both metrics.</p><pre><code class="language-julia hljs">p1 = plot_state_estimates(model)
p2 = plot_predictions(model)
plot(p1,p2, layout= (2,1))</code></pre><p><img src="../figures/bioeconomic_model_eval.png" alt/></p><h3 id="Results:"><a class="docs-heading-anchor" href="#Results:">Results:</a><a id="Results:-1"></a><a class="docs-heading-anchor-permalink" href="#Results:" title="Permalink"></a></h3><h4 id="Counterfactual-prediction"><a class="docs-heading-anchor" href="#Counterfactual-prediction">Counterfactual prediction</a><a id="Counterfactual-prediction-1"></a><a class="docs-heading-anchor-permalink" href="#Counterfactual-prediction" title="Permalink"></a></h4><p>We use the model to predict the harvest level and abundance of the population under limited entry and open access after 1992 when regulations were imposed. Under limited entry, the model predictions closely match historical data, with harvest decreasing and abundance increasing. Under open access conditions, the model predicts the system will approach an equilibrium with much lower abundance than observed in the historical data with harvest remaining relatively constant after 1992.</p><pre><code class="language-julia hljs">u1991 = reshape(model.data[:,model.times .== 1991],2)
times_OA = collect(1940:1972) # 22 years under open access conditions
times_LE = collect(1991:2020) # 22 years under regulation
forecast_OA = UniversalDiffEq.forecast(model,u1991, times_OA)
forecast_LE = UniversalDiffEq.forecast(model,u1991, times_LE)
plt = Plots.scatter(state_variables.t, state_variables.H,c=1, label = &quot;Catch Historical&quot;)
Plots.scatter!(state_variables.t,log.(state_variables.y),c=2, label = &quot;Abundance Historical&quot;)
Plots.plot!(1991 .+ forecast_OA[:,1] .- forecast_OA[1,1], forecast_OA[:,2], width = 2,c=1, label = &quot;Catch Counter Factual&quot;)
Plots.plot!(1991 .+ forecast_OA[:,1].- forecast_OA[1,1],log.(forecast_OA[:,3]), width = 2,c=2, label = &quot;Abundance Counter Factual&quot;,xlabel = &quot;Time&quot;, ylabel = &quot;(log) Biomass&quot;)
Plots.plot!(forecast_LE[:,1], forecast_LE[:,2], width = 2,c=1, label = &quot;Forecast&quot;, linestyle = :dash)
Plots.plot!(forecast_LE[:,1],log.(forecast_LE[:,3]), width = 2,c=2, label = &quot;Forecast&quot;, xlabel = &quot;Time&quot;, ylabel = &quot;(log) Biomass&quot;, linestyle = :dash)</code></pre><p><img src="../figures/bioeconomic_predictions.png" alt/></p><h4 id="Dynamics-before-and-after-regulation"><a class="docs-heading-anchor" href="#Dynamics-before-and-after-regulation">Dynamics before and after regulation</a><a id="Dynamics-before-and-after-regulation-1"></a><a class="docs-heading-anchor-permalink" href="#Dynamics-before-and-after-regulation" title="Permalink"></a></h4><p>The limited entry regulations produced a qualitative change in the dynamics of the coupled human-natural system. Prior to regulations, our model predicts the system had oscillating dynamics around a stable equilibrium. These dynamics are characteristic of the bioeconomic cycles predicted by theoretical models of open-access fisheries. When regulated, the cycling dynamics disappear and the model predicts declining harvest and increasing biomass over most of the state space.</p><pre><code class="language-julia hljs">p1 = vectorfield_and_nullclines(model,0, upper = [0.3,4.0], arrow_color = &quot;blue&quot;,legend = :none,title = &quot;Open Access&quot;,xlabel = &quot;Harvest&quot;, ylabel = &quot;Abundance&quot;)
p2 = vectorfield_and_nullclines(model,1, upper = [0.3,4.0], arrow_color = &quot;blue&quot;,legend = :topright,title = &quot;Limited Entry&quot;,xlabel = &quot;Harvest&quot;, ylabel = &quot;&quot;)
plt = plot(p1,p2)</code></pre><p><img src="../figures/bioeconomic_phase_portrait.png" alt/></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../modelanalysis/">« Model analysis</a><a class="docs-footer-nextpage" href="../API/">API »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.3.0 on <span class="colophon-date" title="Thursday 6 November 2025 18:58">Thursday 6 November 2025</span>. Using Julia version 1.10.10.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
