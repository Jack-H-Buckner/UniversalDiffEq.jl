<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Training routines (This section is incomepte see the docuemtnation for the train! funiton in the API) · UniversalDiffEq.jl</title><meta name="title" content="Training routines (This section is incomepte see the docuemtnation for the train! funiton in the API) · UniversalDiffEq.jl"/><meta property="og:title" content="Training routines (This section is incomepte see the docuemtnation for the train! funiton in the API) · UniversalDiffEq.jl"/><meta property="twitter:title" content="Training routines (This section is incomepte see the docuemtnation for the train! funiton in the API) · UniversalDiffEq.jl"/><meta name="description" content="Documentation for UniversalDiffEq.jl."/><meta property="og:description" content="Documentation for UniversalDiffEq.jl."/><meta property="twitter:description" content="Documentation for UniversalDiffEq.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">UniversalDiffEq.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">UniversalDiffEq.jl</a></li><li><a class="tocitem" href="../Models/">Model Constructors</a></li><li><a class="tocitem" href="../EasyModels/">Easy NODE and UDE</a></li><li><a class="tocitem" href="../ModelTesting/">Model performance</a></li><li><a class="tocitem" href="../NutsAndBolts/">UDE model construction</a></li><li><a class="tocitem" href="../MultipleTimeSeries/">Fitting a model to multiple time series</a></li><li><a class="tocitem" href="../modelanalysis/">Model analysis</a></li><li><a class="tocitem" href="../BayesianModels/">Bayesian Models</a></li><li><a class="tocitem" href="../examples/">Examples</a></li><li><a class="tocitem" href="../API/">API</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Training routines (This section is incomepte see the docuemtnation for the train! funiton in the API)</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Training routines (This section is incomepte see the docuemtnation for the train! funiton in the API)</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/Jack-H-Buckner/UniversalDiffEq.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/Jack-H-Buckner/UniversalDiffEq.jl/blob/main/docs/src/TrainingRoutines.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Training-routines-(This-section-is-incomepte-see-the-docuemtnation-for-the-train!-funiton-in-the-API)"><a class="docs-heading-anchor" href="#Training-routines-(This-section-is-incomepte-see-the-docuemtnation-for-the-train!-funiton-in-the-API)">Training routines (This section is incomepte see the docuemtnation for the train! funiton in the API)</a><a id="Training-routines-(This-section-is-incomepte-see-the-docuemtnation-for-the-train!-funiton-in-the-API)-1"></a><a class="docs-heading-anchor-permalink" href="#Training-routines-(This-section-is-incomepte-see-the-docuemtnation-for-the-train!-funiton-in-the-API)" title="Permalink"></a></h1><p>There are many differnt methods for training NODE and UDE models. These methods tradeoff between accuracy, stability, and computing time. Their performance may also be related to the characteristics of the training data. However, this is an active area of research where it is difficult to make definitive statements. </p><p>Currently, UniversalDiffEq.jl implements fixed loss functions and two different optimization algorithms that can be accessed through the <code>train!</code> function. The logic behind each method and details of implementation can be found below.</p><h2 id="loss-functions"><a class="docs-heading-anchor" href="#loss-functions">loss functions</a><a id="loss-functions-1"></a><a class="docs-heading-anchor-permalink" href="#loss-functions" title="Permalink"></a></h2><h3 id="Derivative-matching"><a class="docs-heading-anchor" href="#Derivative-matching">Derivative matching</a><a id="Derivative-matching-1"></a><a class="docs-heading-anchor-permalink" href="#Derivative-matching" title="Permalink"></a></h3><p>Derivative matching is the most computationally efficient training procedure implemented by UniversalDiffEq.jl. It works for continuous time models such as those implemented by <code>CustomDerivatives</code> or <code>NODE</code> model building functions. This method was adapted from a tutorial in the DiffEqFlux.jl (documentation)[https://docs.sciml.ai/DiffEqFlux/stable/examples/collocation/] called smooth collocation for fast two-stage training.</p><p>Derivative matching trains the models using a two-step procedure. First, the algorithm fits a smoothing curve <span>$s_i(t)$</span> to each dimension <span>$i$</span> of the time series using a cubic spline implemented by the DataInterpolations.jl package. The model is trained by comparing the right-hand side <span>$f$</span> of the UDE model to the derivatives of the smoothing curve, evaluated at the time of each observation in the data set. </p><p class="math-container">\[L(\theta) = \sum_i \sum_{\tau\in T} \left(\frac{ds_i}/{dt} |_\tau - f_i(s(\tau)\rigt)^2 + \omega_R |\theta_{w}|_{L2} \]</p><p>The final term <span>$\omega_R |\theta_{w}|_{L2} $ applies $L2$</span> regualrization to the neural network weights <span>$\theta_{w}$</span>. The user can specify the weight <span>$\omega_R$</span> using the keyword argument <code>Regularization_weight</code> in the <code>train!</code> function.</p><p>The algorithm can be tuned for a specific data set using the <code>loss_options</code> keyword argument. This argument should be a NamedTyple with values <code>d</code> and <code>remove_ends</code>. The parameter <code>d</code> sets the number of degrees of freedom used by the curve-fitting model. The <code>remove_ends</code> option is an integer. This allows data points from the beginning and end of the data set to be excluded from the loss function. The default value is zero (no observations are excluded), but the smoothing curves might fit poorly near the beginning and end of some data sets. Setting <code>remove_ends &gt; 0</code> can help reduce the influence of these edge effects on the trained model.The smoothing curves are fit using the generalized cross-validation method in the (DataInterpolations.jl)[https://docs.sciml.ai/DataInterpolations/dev/methods/#Regularization-Smoothing] package. This method fits a continous differntiable curve to the data with a smoothing penelty term chosen to minimize the influecne of observaiton errors. </p><p>The success of the training procedure can be evaluated using the <code>plot_state_estimates</code> and <code>plot_predictions</code> functions. The <code>plot_state_estimates</code> will will plot the data using a scatter plot and over lay the smoothing curves with a line plot allowing a visual inspection of the fits. The plot predictons function will show who well the trained UDE predictes the changes in the smoothing curves forecasting one step ahead.  </p><h3 id="State-space-loss-functions"><a class="docs-heading-anchor" href="#State-space-loss-functions">State-space loss functions</a><a id="State-space-loss-functions-1"></a><a class="docs-heading-anchor-permalink" href="#State-space-loss-functions" title="Permalink"></a></h3><p>State-space loss functions assume the data <span>$y_t \in R^d$</span> can be described by a set of state variables <span>$u_t \in R^d$</span> and observation errors <span>$\epsilon_t \in R^d$</span>. The UDE model <span>$f(u,X(t),t|\theta)$</span> with paramters <span>$\theta$</span> and covariates <span>$X$</span> is used to learn the dynamcis of the state varibles <span>$u_t$</span>.  Combining these assumptions yield two equations that descibe the observation set <span>$y_t$</span></p><p>$</p><p>y<em>t = u</em>t + \epsilon<em>t \  u</em>{t+1} = u<em>t + \int</em>{t}^{t+1} f(u,X(v),v|\theta) dv + \nu_t $</p><p>Given these two equations we can calculate the likelihood of the data <span>$y_t$</span> given the parameters of the UDE <span>$\theta$</span> in two ways, the conditional and marginal likeihood. The conditional likelihood is used in bayesian settings and describes the likelihood of the data given the UDE paramters <span>$\theta$</span> and point estimates of the state variables <span>$\hat{u}_t$</span>. The marginal likelihood desribes the likelihood of the observaitons <span>$y_t$</span> given the model parameters <span>$\theta$</span> while accounting for uncertianty in the estimates of the state variables <span>$u_t$</span>. The marginal likelihood is used in frequenties setting and produces unbiased maximum likelihood estiamtes of the paramters <span>$\theta$</span>. In paractice, both likelihood functions can be used to train the UDE models with good results. The conditional likeihood is more compuationally efficent, while the marginal likelihood is, in theory, more accurate. </p><h4 id="Conditional-likelihood"><a class="docs-heading-anchor" href="#Conditional-likelihood">Conditional likelihood</a><a id="Conditional-likelihood-1"></a><a class="docs-heading-anchor-permalink" href="#Conditional-likelihood" title="Permalink"></a></h4><p>We calcualte the conditional likelihood by jointly estimating the UDE model parameters <span>$\theta$</span> and the value of the underlying state variables <span>$\hat{u}_t$</span>. We assume that the process <span>$\nu_{i,t}$</span> and observation errors <span>$\epsilon_{i,t}$</span> along each dimesnon of the data set <span>$i\in \{1:d\}$</span>, are independnet identically distributed normal random variables with variances <span>$\tau^2$</span> and <span>$\sigma^2$</span> respectively. </p><p>Given this assumption the log likelihood function has two components, a term corresponding to the observation errors, and term corresponding to the process process errors. The observation error term is the sum of the mean squared observaiton errors scaled by the observaiton variance  <span>$\sigma^2$</span></p><p>$</p><p>L<em>{obs}(\hat{u}) = \sum</em>{t=1}^{T} \sum<em>{i=1}^{d} \left( \frac{y</em>{i,t}-\hat{u}_{i,t}}{\sigma}\right)^2 $</p><p>The process error term has the same stucture but it calcautle the sum of squarred process errors</p><p>$</p><p>L<em>{proc}(\hat{u},\theta) = \sum</em>{t=1}^{T} \sum<em>{i=1}^{d} \left( \frac{\hat{u}</em>{i,t+1} - F(\hat{u}_t,t,\theta)}{\tau}\right)^2,  $</p><p>where</p><p>$</p><p>F(u,\theta) = u + \int<em>{t}^{t+1} f(u,X(v),v|\theta) dv + \nu</em>t. $</p><p>Combining these terms yields the log conditiona likeihood function </p><p>$</p><p>L(\hat{u},\theta) = L<em>{obs}(\hat{u}) + L</em>{proc}(\hat{u},\theta). $</p><h4 id="Marginal"><a class="docs-heading-anchor" href="#Marginal">Marginal</a><a id="Marginal-1"></a><a class="docs-heading-anchor-permalink" href="#Marginal" title="Permalink"></a></h4><p>We calcualte the marginal likeihood using an unscented kalman filters. </p><p>$</p><p>\Pi<em>{t=1}^{T}\int</em>{-\infty}^{\infty} \left(\frac{y<em>t-u</em>t}{\sigma}\right)^2f(u<em>t;{y}</em>{1:(t-1)},\theta) $</p><h3 id="Shooting"><a class="docs-heading-anchor" href="#Shooting">Shooting</a><a id="Shooting-1"></a><a class="docs-heading-anchor-permalink" href="#Shooting" title="Permalink"></a></h3><h3 id="Multiple-shooting"><a class="docs-heading-anchor" href="#Multiple-shooting">Multiple shooting</a><a id="Multiple-shooting-1"></a><a class="docs-heading-anchor-permalink" href="#Multiple-shooting" title="Permalink"></a></h3></article><nav class="docs-footer"><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.3.0 on <span class="colophon-date" title="Tuesday 25 February 2025 22:31">Tuesday 25 February 2025</span>. Using Julia version 1.10.8.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
